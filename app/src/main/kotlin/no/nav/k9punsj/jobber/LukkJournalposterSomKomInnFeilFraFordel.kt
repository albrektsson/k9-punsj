package no.nav.k9punsj.jobber

import kotlinx.coroutines.delay
import kotlinx.coroutines.runBlocking
import no.nav.k9punsj.akjonspunkter.AksjonspunktServiceImpl
import no.nav.k9punsj.journalpost.JournalpostService
import org.slf4j.LoggerFactory
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.scheduling.annotation.Scheduled
import org.springframework.stereotype.Service

@Service
class LukkJournalposterSomKomInnFeilFraFordel @Autowired constructor(
    val aksjonspunktServiceImpl: AksjonspunktServiceImpl,
    val journalpostService: JournalpostService
) {

    private val logger = LoggerFactory.getLogger(LukkJournalposterSomKomInnFeilFraFordel::class.java)

    //kjører klokken 03:00
    @Scheduled(cron = "0 0 3 * * *")
    fun sjekkeOmAksjonspunktHarLøptUt() {
        runBlocking {

            for ((index, journalpostId) in listeMedJournalposterSomSkalLukkes.withIndex()) {
                if (journalpostService.kanSendeInn(journalpostId)) {
                    aksjonspunktServiceImpl.settUtførtPåAltSendLukkOppgaveTilK9Los(journalpostId, false)
                    journalpostService.settTilFerdig(journalpostId)
                    logger.info("$journalpostId er sendt til los og lukket")
                } else {
                    logger.info("Har håndert $journalpostId fra før")
                }
                logger.info("""Ferdig med $index av ${listeMedJournalposterSomSkalLukkes.size}""")
                //venter 1 sekund
                delay(1000)
            }
        }
    }

    private companion object {
        // en liste med journalposter som ble sendt feilaktig til punsj fra k9-fordel pga en feil i Altinn
        //https://github.com/navikt/k9-fordel/commit/2957b11759c0fcef1752986cbf14568f8b629018
        private val listeMedJournalposterSomSkalLukkes = setOf(
        "545426642",
        "545350439",
        "545348573",
        "545348066",
        "545347910",
        "545347935",
        "545347838",
        "545347738",
        "545347623",
        "545347560",
        "545347520",
        "545347123",
        "545347025",
        "545345506",
        "545345121",
        "545344990",
        "545344216",
        "545344059",
        "545343728",
        "545343656",
        "545343566",
        "545343516",
        "545343386",
        "545342964",
        "545341802",
        "545341490",
        "545340440",
        "545339413",
        "545339135",
        "545339083",
        "545338498",
        "545337298",
        "545337120",
        "545336557",
        "545335308",
        "545334704",
        "545334137",
        "545334093",
        "545332891",
        "545332464",
        "545332406",
        "545331477",
        "545331329",
        "545331239",
        "545330362",
        "545329674",
        "545329599",
        "545329469",
        "545328193",
        "545327878",
        "545327159",
        "545326959",
        "545326371",
        "545326274",
        "545325762",
        "545325752",
        "545325678",
        "545325001",
        "545324388",
        "545324374",
        "545324045",
        "545323852",
        "545323613",
        "545323353",
        "545322604",
        "545322218",
        "545322121",
        "545321903",
        "545321627",
        "545320998",
        "545320734",
        "545319624",
        "545317429",
        "545317170",
        "545316981",
        "545316974",
        "545316837",
        "545316667",
        "545316256",
        "545315661",
        "545314825",
        "545313467",
        "545311652",
        "545311267",
        "545309759",
        "545309147",
        "545308470",
        "545308410",
        "545308333",
        "545308132",
        "545308104",
        "545305589",
        "545305586",
        "545305263",
        "545304062",
        "545304394",
        "545304182",
        "545303831",
        "545303630",
        "545303470",
        "545303142",
        "545302554",
        "545303151",
        "545302255",
        "545302251",
        "545302260",
        "545302514",
        "545302371",
        "545302349",
        "545302201",
        "545302204",
        "545302212",
        "545301587",
        "545301227",
        "545296741",
        "545296331",
        "545296068",
        "545295244",
        "545295007",
        "545293928",
        "545290134",
        "545286808",
        "545285015",
        "545284844",
        "545283149",
        "545283082",
        "545281240",
        "545279517",
        "545279156",
        "545276136",
        "545274840",
        "545272902",
        "545272340",
        "545269555",
        "545268681",
        "545266512",
        "545266343",
        "545264583",
        "545263840",
        "545263124",
        "545262783",
        "545257733",
        "545257128",
        "545256275",
        "545255761",
        "545253276",
        "545252968",
        "545250116",
        "545250065",
        "545247828",
        "545245455",
        "545244079",
        "545244075",
        "545243747",
        "545243800",
        "545243148",
        "545242659",
        "545242090",
        "545241294",
        "545241405",
        "545241351",
        "545241382",
        "545241347",
        "545241337",
        "545241312",
        "545241301",
        "545241279",
        "545241229",
        "545241256",
        "545241214",
        "545241207",
        "545241159",
        "545241171",
        "545241143",
        "545241122",
        "545241135",
        "545241035",
        "545240668",
        "545241072",
        "545241054",
        "545241014",
        "545240993",
        "545240942",
        "545240970",
        "545240963",
        "545240954",
        "545240858",
        "545240896",
        "545240890",
        "545240888",
        "545240873",
        "545240849",
        "545240828",
        "545240837",
        "545240741",
        "545240807",
        "545240792",
        "545240781",
        "545240730",
        "545240746",
        "545240687",
        "545240610",
        "545239946",
        "545239652",
        "545237607",
        "545235786",
        "545235713",
        "545234797",
        "545233335",
        "545232903",
        "545232706",
        "545230984",
        "545230841",
        "545230815",
        "545230183",
        "545229214",
        "545227325",
        "545227283",
        "545227300",
        "545226913",
        "545226461",
        "545226339",
        "545226328",
        "545226125"
        )
    }
}
